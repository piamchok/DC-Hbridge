#include <WiFi.h>
#include <MQTT.h>

// --- Config ---
const char ssid[] = "YOUR_WIFI_SSID";
const char pass[] = "YOUR_WIFI_PASS";

const char mqtt_broker[] = "broker.hivemq.com";
const char mqtt_client_id[] = "esp32_ldr_client_002"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥
String topic_prefix = "my_project_user1"; // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì

// --- Pins ---
const int LDR_PIN = 34;   // Analog Input
const int MOTOR_PIN = 26; // ‡∏ï‡πà‡∏≠ Transistor ‡∏´‡∏£‡∏∑‡∏≠ IN1
const int LED1_PIN = 18;  // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
const int LED2_PIN = 19;  // ‡∏´‡∏¢‡∏∏‡∏î

// --- Variables ---
WiFiClient net;
MQTTClient client;
unsigned long lastMillis = 0;

bool isEmergency = false;
bool isReset = false;
int ldrValue = 0;

// --- Helper Functions ---
void setMotor(bool state) {
  digitalWrite(MOTOR_PIN, state ? HIGH : LOW);
  client.publish(topic_prefix + "/motor/status", state ? "Running" : "Stopped");
}

void setLeds(bool led1, bool led2) {
  digitalWrite(LED1_PIN, led1 ? HIGH : LOW);
  digitalWrite(LED2_PIN, led2 ? HIGH : LOW);
  client.publish(topic_prefix + "/led1/status", led1 ? "ON" : "OFF");
  client.publish(topic_prefix + "/led2/status", led2 ? "ON" : "OFF");
}

void connect() {
  Serial.print("Checking WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print("."); delay(1000);
  }

  Serial.print("\nMQTT Connecting...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print("."); delay(1000);
  }
  Serial.println("\nMQTT Connected!");

  client.subscribe(topic_prefix + "/emergency"); // payload: press
  client.subscribe(topic_prefix + "/reset");     // payload: press
}

// --- Callback ---
void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming: " + topic + " - " + payload);

  // 1. Emergency Stop
  if (topic.endsWith("/emergency") && payload == "press") {
    isEmergency = !isEmergency; // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Toggle)
    isReset = false; // ‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å Reset state
    Serial.println(isEmergency ? "EMERGENCY MODE!" : "Emergency Cleared");
    
    if (isEmergency) {
      setMotor(false); 
      setLeds(false, true); // ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    }
  }

  // 2. Reset System
  if (topic.endsWith("/reset") && payload == "press") {
    Serial.println("SYSTEM RESET");
    isReset = true;
    isEmergency = false;
    setMotor(false);
    setLeds(false, false); // ‡∏î‡∏±‡∏ö‡∏´‡∏°‡∏î
  }
}

void setup() {
  Serial.begin(115200);

  pinMode(MOTOR_PIN, OUTPUT);
  pinMode(LED1_PIN, OUTPUT);
  pinMode(LED2_PIN, OUTPUT);
  pinMode(LDR_PIN, INPUT);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏°‡∏î
  digitalWrite(MOTOR_PIN, LOW);
  digitalWrite(LED1_PIN, LOW);
  digitalWrite(LED2_PIN, LOW);

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, 1883, net);
  client.onMessage(messageReceived);

  connect();
}

void loop() {
  client.loop();
  delay(10);

  if (!client.connected()) connect();

  // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ LDR)
  if (millis() - lastMillis > 1000) {
    lastMillis = millis();
    
    ldrValue = analogRead(LDR_PIN);
    Serial.print("LDR: "); Serial.println(ldrValue);
    client.publish(topic_prefix + "/ldr", String(ldrValue));

    // Logic ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    if (isReset) {
       // ‡∏ñ‡πâ‡∏≤ Reset ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÅ‡∏™‡∏á‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (Auto-arm)
       isReset = false; 
    }
    else if (isEmergency) {
       // ‡∏ñ‡πâ‡∏≤ Emergency ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
       setMotor(false);
       setLeds(false, true); 
    }
    else {
       // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏ï‡∏≤‡∏°‡πÅ‡∏™‡∏á
       if (ldrValue < 300) { // ‡∏°‡∏∑‡∏î
         setMotor(true);
         setLeds(true, false); // LED1 ‡∏ï‡∏¥‡∏î
       } else { // ‡∏™‡∏ß‡πà‡∏≤‡∏á
         setMotor(false);
         setLeds(false, true); // LED2 ‡∏ï‡∏¥‡∏î
       }
    }
  }
}
‡πÇ‡∏à‡∏ó‡∏¢‡πå LDR + Transistor (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + Emergency) ‡∏™‡∏£‡πâ‡∏≤‡∏á Tiles (‡∏ä‡πà‡∏≠‡∏á) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 6 ‡∏≠‡∏±‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö:
Tile 1: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏á (Text) Type: Text (Subscribe)

Topic: my_project_user1/ldr

Label: ‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏á (LDR)

Tile 2: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå (Text) Type: Text (Subscribe)

Topic: my_project_user1/motor/status

Label: ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô?

Tile 3: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LED1 (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) (Text) Type: Text (Subscribe)

Topic: my_project_user1/led1/status

Label: LED1 (Run)

Tile 4: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LED2 (‡∏´‡∏¢‡∏∏‡∏î) (Text) Type: Text (Subscribe)

Topic: my_project_user1/led2/status

Label: LED2 (Stop)

Tile 5: ‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Button - Emergency) Type: Button (Publish)

Topic: my_project_user1/emergency

Payload: press

Label: üö® EMERGENCY STOP

Color: (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡πÅ‡∏î‡∏á)

Tile 6: ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (Button - Reset) Type: Button (Publish)

Topic: my_project_user1/reset

Payload: press

Label: üîÑ RESET SYSTEM

Color: (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
