#include <WiFi.h>
#include <MQTT.h>

// --- Config ---
const char ssid[] = "YOUR_WIFI_SSID";
const char pass[] = "YOUR_WIFI_PASS";

const char mqtt_broker[] = "broker.hivemq.com";
const char mqtt_client_id[] = "esp32_ldr_client_002"; // เปลี่ยนเลขอย่าให้ซ้ำ
String topic_prefix = "my_project_user1"; // <-- เปลี่ยนเป็นชื่อคุณ

// --- Pins ---
const int LDR_PIN = 34;   // Analog Input
const int MOTOR_PIN = 26; // ต่อ Transistor หรือ IN1
const int LED1_PIN = 18;  // ทำงาน
const int LED2_PIN = 19;  // หยุด

// --- Variables ---
WiFiClient net;
MQTTClient client;
unsigned long lastMillis = 0;

bool isEmergency = false;
bool isReset = false;
int ldrValue = 0;

// --- Helper Functions ---
void setMotor(bool state) {
  digitalWrite(MOTOR_PIN, state ? HIGH : LOW);
  client.publish(topic_prefix + "/motor/status", state ? "Running" : "Stopped");
}

void setLeds(bool led1, bool led2) {
  digitalWrite(LED1_PIN, led1 ? HIGH : LOW);
  digitalWrite(LED2_PIN, led2 ? HIGH : LOW);
  client.publish(topic_prefix + "/led1/status", led1 ? "ON" : "OFF");
  client.publish(topic_prefix + "/led2/status", led2 ? "ON" : "OFF");
}

void connect() {
  Serial.print("Checking WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print("."); delay(1000);
  }

  Serial.print("\nMQTT Connecting...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print("."); delay(1000);
  }
  Serial.println("\nMQTT Connected!");

  client.subscribe(topic_prefix + "/emergency"); // payload: press
  client.subscribe(topic_prefix + "/reset");     // payload: press
}

// --- Callback ---
void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming: " + topic + " - " + payload);

  // 1. Emergency Stop
  if (topic.endsWith("/emergency") && payload == "press") {
    isEmergency = !isEmergency; // สลับสถานะ (Toggle)
    isReset = false; // หลุดจาก Reset state
    Serial.println(isEmergency ? "EMERGENCY MODE!" : "Emergency Cleared");
    
    if (isEmergency) {
      setMotor(false); 
      setLeds(false, true); // หยุดทำงาน
    }
  }

  // 2. Reset System
  if (topic.endsWith("/reset") && payload == "press") {
    Serial.println("SYSTEM RESET");
    isReset = true;
    isEmergency = false;
    setMotor(false);
    setLeds(false, false); // ดับหมด
  }
}

void setup() {
  Serial.begin(115200);

  pinMode(MOTOR_PIN, OUTPUT);
  pinMode(LED1_PIN, OUTPUT);
  pinMode(LED2_PIN, OUTPUT);
  pinMode(LDR_PIN, INPUT);

  // เริ่มต้นปิดหมด
  digitalWrite(MOTOR_PIN, LOW);
  digitalWrite(LED1_PIN, LOW);
  digitalWrite(LED2_PIN, LOW);

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, 1883, net);
  client.onMessage(messageReceived);

  connect();
}

void loop() {
  client.loop();
  delay(10);

  if (!client.connected()) connect();

  // ทำงานทุกๆ 1 วินาที (อ่านค่า LDR)
  if (millis() - lastMillis > 1000) {
    lastMillis = millis();
    
    ldrValue = analogRead(LDR_PIN);
    Serial.print("LDR: "); Serial.println(ldrValue);
    client.publish(topic_prefix + "/ldr", String(ldrValue));

    // Logic การทำงาน
    if (isReset) {
       // ถ้า Reset อยู่ ให้เคลียร์ค่าแล้วเริ่มวัดแสงรอบถัดไปได้เลย (Auto-arm)
       isReset = false; 
    }
    else if (isEmergency) {
       // ถ้า Emergency ต้องหยุดเสมอ
       setMotor(false);
       setLeds(false, true); 
    }
    else {
       // ทำงานปกติ ตามแสง
       if (ldrValue < 300) { // มืด
         setMotor(true);
         setLeds(true, false); // LED1 ติด
       } else { // สว่าง
         setMotor(false);
         setLeds(false, true); // LED2 ติด
       }
    }
  }
}
