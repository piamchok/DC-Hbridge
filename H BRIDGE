#include <WiFi.h>
#include <MQTT.h>

// --- Config ---
const char ssid[] = "YOUR_WIFI_SSID";
const char pass[] = "YOUR_WIFI_PASS";

// ใช้ HiveMQ หรือ Mosquitto ก็ได้ (ในตัวอย่างใช้ตามที่คุณส่งมา)
const char mqtt_broker[] = "broker.hivemq.com"; 
const char mqtt_client_id[] = "esp32_motor_client_001"; // เปลี่ยนเลขอย่าให้ซ้ำ
String topic_prefix = "my_project_user1"; // <-- เปลี่ยนเป็นชื่อคุณ

// --- Pins ---
const int IN1 = 26;
const int IN2 = 27;
const int LED_PIN = 22;
const int BTN_PIN = 0; // ใช้ปุ่ม BOOT

// --- Variables ---
WiFiClient net;
MQTTClient client;
unsigned long lastMillis = 0;

String motorState = "STOP";
String lastRunDirection = "LEFT"; // Default
int buttonStep = 0; // 0=Stop, 1=Left, 2=Right

// Debounce
int lastButtonState = HIGH;
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50;

// --- Helper Functions ---
void controlMotor(String direction) {
  if (direction == "LEFT") {
    digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
    motorState = "LEFT";
    lastRunDirection = "LEFT";
    buttonStep = 1;
  } else if (direction == "RIGHT") {
    digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
    motorState = "RIGHT";
    lastRunDirection = "RIGHT";
    buttonStep = 2;
  } else {
    digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
    motorState = "STOP";
    buttonStep = 0;
  }
  
  // Publish Status ทันทีที่มีการเปลี่ยน
  client.publish(topic_prefix + "/motor/status", motorState);
}

void connect() {
  Serial.print("Checking WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print("."); delay(1000);
  }

  Serial.print("\nMQTT Connecting...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print("."); delay(1000);
  }
  Serial.println("\nMQTT Connected!");

  // Subscribe topics
  client.subscribe(topic_prefix + "/motor/control"); // payload: left, right, stop
  client.subscribe(topic_prefix + "/led/control");   // payload: on
}

// --- Callback เมื่อได้รับข้อความ ---
void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming: " + topic + " - " + payload);

  // 1. Motor Control
  if (topic.endsWith("/motor/control")) {
    if (payload == "left") controlMotor("LEFT");
    else if (payload == "right") controlMotor("RIGHT");
    else if (payload == "stop") controlMotor("STOP");
  }

  // 2. LED Control (Special Logic: ON -> Reverse Motor)
  if (topic.endsWith("/led/control")) {
    if (payload == "on") {
      Serial.println("LED ON Cmd -> Reversing Motor!");
      if (lastRunDirection == "LEFT") controlMotor("RIGHT");
      else controlMotor("LEFT");
    }
  }
}

void setup() {
  Serial.begin(115200);
  
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BTN_PIN, INPUT_PULLUP);

  controlMotor("STOP");

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, 1883, net);
  client.onMessage(messageReceived);

  connect();
}

void loop() {
  client.loop();
  delay(10); 

  if (!client.connected()) connect();

  // --- 1. อ่านปุ่มกด (Single Button Logic) ---
  int reading = digitalRead(BTN_PIN);
  if (reading != lastButtonState) lastDebounceTime = millis();

  if ((millis() - lastDebounceTime) > debounceDelay) {
    static int currentButtonState = HIGH;
    if (reading != currentButtonState) {
      currentButtonState = reading;
      if (currentButtonState == LOW) { // กดลง
        Serial.println("Button Pressed");
        if (motorState == "STOP") controlMotor("LEFT");
        else if (motorState == "LEFT") controlMotor("RIGHT");
        else if (motorState == "RIGHT") controlMotor("STOP");
      }
    }
  }
  lastButtonState = reading;

  // --- 2. อัปเดต LED ---
  static String lastLedState = "";
  if (motorState != "STOP") {
    digitalWrite(LED_PIN, HIGH);
    if (lastLedState != "ON") {
      client.publish(topic_prefix + "/led/status", "ON");
      lastLedState = "ON";
    }
  } else {
    digitalWrite(LED_PIN, LOW);
    if (lastLedState != "OFF") {
      client.publish(topic_prefix + "/led/status", "OFF");
      lastLedState = "OFF";
    }
  }
}


Tile 1: สั่งหมุนซ้าย (Button) Type: Button (Publish)

Topic: my_project_user1/motor/control

Payload: left

Label: หมุนซ้าย

Icon: (รูปลูกศรซ้าย)

Tile 2: สั่งหมุนขวา (Button) Type: Button (Publish)

Topic: my_project_user1/motor/control

Payload: right

Label: หมุนขวา

Icon: (รูปลูกศรขวา)

Tile 3: สั่งหยุด (Button) Type: Button (Publish)

Topic: my_project_user1/motor/control

Payload: stop

Label: หยุด

Icon: (รูปสี่เหลี่ยมหยุด)

Tile 4: สั่ง LED ติด (เพื่อกลับทางหมุน) (Button) Type: Button (Publish)

Topic: my_project_user1/led/control

Payload: on

Label: LED ON (กลับทาง)

Icon: (รูปหลอดไฟ)

Tile 5: แสดงสถานะมอเตอร์ (Text) Type: Text (Subscribe)

Topic: my_project_user1/motor/status

Label: สถานะ Motor

Tile 6: แสดงสถานะ LED (Text) Type: Text (Subscribe)

Topic: my_project_user1/led/status

Label: สถานะไฟ
