#include <WiFi.h>
#include <MQTT.h>
#include <Stepper.h>

// --- 1. Config ---
const char ssid[] = "YOUR_WIFI_SSID";
const char pass[] = "YOUR_WIFI_PASS";

const char mqtt_broker[] = "broker.hivemq.com";
const char mqtt_client_id[] = "esp32_stepper_angle_001"; 
String topic_prefix = "my_project_user1"; // <-- เปลี่ยนเป็นชื่อคุณ

// --- 2. Stepper Config ---
// มอเตอร์ 28BYJ-48 ปกติคือ 2048 steps/rev
const int STEPS_PER_REV = 2048; 

// ขา Driver L298N (IN1, IN3, IN2, IN4)
const int IN1 = 26;
const int IN2 = 27;
const int IN3 = 14;
const int IN4 = 12;

Stepper myStepper(STEPS_PER_REV, IN1, IN3, IN2, IN4); 

const int LED_PIN = 22;
const int BTN_PIN = 0; // ปุ่ม BOOT

// --- 3. Variables ---
WiFiClient net;
MQTTClient client;

String motorState = "STOP";       
String lastRunDirection = "LEFT"; 

// ตัวแปรนับตำแหน่ง (สำคัญมากสำหรับการหาองศา)
long currentStepCount = 0; 
unsigned long lastPublishTime = 0; // เพื่อไม่ให้ส่ง MQTT ถี่เกินไป

// ปุ่มกด
int lastButtonState = HIGH;
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50;

// --- Helper Functions ---
void connect() {
  Serial.print("Checking WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print("."); delay(1000);
  }

  Serial.print("\nMQTT Connecting...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print("."); delay(1000);
  }
  Serial.println("\nMQTT Connected!");

  client.subscribe(topic_prefix + "/motor/control");
  client.subscribe(topic_prefix + "/led/control");
}

void setMotorState(String state) {
  motorState = state;
  if (state == "LEFT") lastRunDirection = "LEFT";
  else if (state == "RIGHT") lastRunDirection = "RIGHT";
  else {
    // หยุด: ตัดไฟเข้าขดลวด
    digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
    digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
  }
  client.publish(topic_prefix + "/motor/status", motorState);
}

void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming: " + topic + " - " + payload);
  if (topic.endsWith("/motor/control")) {
    if (payload == "left") setMotorState("LEFT");
    else if (payload == "right") setMotorState("RIGHT");
    else if (payload == "stop") setMotorState("STOP");
  }
  if (topic.endsWith("/led/control") && payload == "on") {
     // ไฟติด -> กลับทางหมุน
     if (lastRunDirection == "LEFT") setMotorState("RIGHT");
     else setMotorState("LEFT");
  }
}

void setup() {
  Serial.begin(115200);
  myStepper.setSpeed(10); // RPM

  pinMode(LED_PIN, OUTPUT);
  pinMode(BTN_PIN, INPUT_PULLUP);
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);

  setMotorState("STOP");

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, 1883, net);
  client.onMessage(messageReceived);
  connect();
}

void loop() {
  client.loop();
  if (!client.connected()) connect();

  // 1. อ่านปุ่มกด (Manual)
  int reading = digitalRead(BTN_PIN);
  if (reading != lastButtonState) lastDebounceTime = millis();
  if ((millis() - lastDebounceTime) > debounceDelay) {
    static int currentButtonState = HIGH;
    if (reading != currentButtonState) {
      currentButtonState = reading;
      if (currentButtonState == LOW) {
        if (motorState == "STOP") setMotorState("LEFT");
        else if (motorState == "LEFT") setMotorState("RIGHT");
        else if (motorState == "RIGHT") setMotorState("STOP");
      }
    }
  }
  lastButtonState = reading;

  // 2. ควบคุมการหมุน + นับ Step
  int stepsToMove = 0;
  
  if (motorState == "LEFT") {
    stepsToMove = 15; // ขยับทีละนิด (ค่าบวก = ตามเข็มหรือทวนเข็มแล้วแต่การต่อสาย)
    myStepper.step(stepsToMove); 
    currentStepCount += stepsToMove; // เพิ่มค่า
  } 
  else if (motorState == "RIGHT") {
    stepsToMove = -15; // ขยับทีละนิด (ค่าลบ = ทิศตรงข้าม)
    myStepper.step(stepsToMove);
    currentStepCount += stepsToMove; // ลดค่า (จริงๆ คือบวกด้วยค่าลบ)
  }

  // 3. คำนวณองศาและส่ง MQTT (ทุกๆ 500ms)
  if (millis() - lastPublishTime > 500) {
    lastPublishTime = millis();
    
    // คำนวณองศา
    // ใช้ fmod เพื่อให้ค่าวนกลับมา 0 เมื่อครบ 360 (หรือปล่อยไว้ถ้าอยากได้ค่าสะสมเรื่อยๆ)
    float currentDegree = (float)currentStepCount / STEPS_PER_REV * 360.0;
    
    // ส่งค่าองศา
    Serial.print("Degree: "); Serial.println(currentDegree);
    client.publish(topic_prefix + "/motor/degree", String(currentDegree, 1)); // ทศนิยม 1 ตำแหน่ง

    // อัปเดตไฟ LED
    if (motorState != "STOP") {
      digitalWrite(LED_PIN, HIGH);
      client.publish(topic_prefix + "/led/status", "ON");
    } else {
      digitalWrite(LED_PIN, LOW);
      client.publish(topic_prefix + "/led/status", "OFF");
    }
  }
}

1. โจทย์มอเตอร์ (Stepper Motor + องศา)
สำหรับปุ่มกด (Publish จากแอปไปหาบอร์ด):

สั่งหมุน/หยุด: my_project_user1/motor/control

ส่งค่า: left, right, stop

สั่งไฟ LED (กลับทาง): my_project_user1/led/control

ส่งค่า: on

สำหรับแสดงผล (Subscribe รับค่าจากบอร์ด):

สถานะมอเตอร์: my_project_user1/motor/status

ค่าองศา: my_project_user1/motor/degree

สถานะ LED: my_project_user1/led/status


